version: 0.1
name: "ref"
package: "github.com/pulap/pulap"

deployment:
  platforms: [nomad]
  nomad:
    datacenter: dc1
    consul_integration: true
    traefik_integration: true
    default_resources:
      cpu: 256
      memory: 128
  infrastructure:
    consul:
      enabled: true
      address: "127.0.0.1:8500"
    traefik:
      enabled: true
      entrypoint: web
      domain: "localhost"

services:
  authn:
    kind: domain
    preset: auth  # Predefined auth implementation - models and aggregates included by default
    repo_impl: [sqlite, mongo]
    deployment:
      nomad:
        port: 8082
        replicas: 1
        resources:
          cpu: 256
          memory: 128
        health_check:
          path: "/health"
          interval: "30s"
        traefik:
          rule: "PathPrefix(`/authn`)"
          priority: 200
        consul:
          service_name: "authn"
          tags: ["authn", "v1"]
  authz:
    kind: domain
    preset: authz  # Predefined authorization implementation - roles, grants, policies included by default
    repo_impl: [sqlite, mongo]
    deployment:
      nomad:
        port: 8083
        replicas: 1
        resources:
          cpu: 256
          memory: 128
        health_check:
          path: "/health"
          interval: "30s"
        traefik:
          rule: "PathPrefix(`/authz`)"
          priority: 201
        consul:
          service_name: "authz"
          tags: ["authz", "v1"]
  todo:
    kind: atom
    repo_impl: [sqlite, mongo]
    auth:
      enabled: true
      mode: development
      required_scopes: ["read:todos", "write:todos"]
    deployment:
      nomad:
        port: 8080
        replicas: 1
        resources:
          cpu: 256
          memory: 128
        health_check:
          path: "/health"
          interval: "30s"
        traefik:
          rule: "PathPrefix(`/estate`)"
          priority: 100
        consul:
          service_name: "estate"
          tags: ["api", "v1"]
    models:
      Item:
        options:
          audit: true
          lifecycle: [before_create, before_update]
        fields:
          text: {type: text, validations: [{name: required}]}
          done: {type: bool, default: false}
      Tag:
        options:
          audit: true
          lifecycle: [before_create, before_update]
        fields:
          name: {type: string, validations: [{name: required}]}
          color: {type: string, default: "blue"}
    aggregates:
      List:
        audit: true
        fields:
          name: {type: string, validations: [{name: required}]}
          description: {type: text}
        children:
          items:
            of: Item
            audit: true
          tags:
            of: Tag
            audit: true
    api:
      base_path: /estate
      handlers:
        - id: todo_items_list
          route: "GET /items"
          source: repo
          model: Item
          op: list
        - id: todo_items_create
          route: "POST /items"
          source: repo
          model: Item
          op: create
        - id: todo_items_get
          route: "GET /items/{id}"
          source: repo
          model: Item
          op: get
        - id: todo_items_update
          route: "PATCH /items/{id}"
          source: repo
          model: Item
          op: update
        - id: todo_items_delete
          route: "DELETE /items/{id}"
          source: repo
          model: Item
          op: delete